<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel de Control | Psicofitt</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    /* ---------- Estilos (preservados + mejoras) ---------- */
    :root{
      --primary:#2b3a67;
      --accent:#6A9B7A; /* VERDE SALVIA */
      --bg:#f8f9fa;
      --bg-card: #ffffff;
      --muted:#6c757d;
      --success: #1e7e34;
      --danger: #d9534f;
      --info: #007bff;
      --shadow-subtle: 0 4px 10px rgba(0,0,0,0.05);
    }
    *{box-sizing:border-box}
    body{
      font-family:'Montserrat', sans-serif;
      margin:0;
      background-color:var(--bg);
      color:var(--primary);
    }
    .wrapper{
      display:flex;
      min-height:100vh;
    }
    .sidebar{
      width:250px;
      background-color:var(--primary);
      color:white;
      padding:20px;
      box-shadow:2px 0 10px rgba(0,0,0,0.3);
      display:flex;
      flex-direction:column;
      position:sticky;
      top:0;
      height:100vh;
    }
    .logo-text{
      font-family:'Playfair Display', serif;
      font-size:1.8rem;
      font-weight:700;
      margin-bottom:20px;
      color:white;
      text-align:center;
    }
    .profile-info{
      text-align:center;
      padding-bottom:20px;
      border-bottom:1px solid rgba(255,255,255,0.2);
      margin-bottom:20px;
    }
    .profile-info h4{margin:0;font-size:1.1rem;}
    .profile-info p{margin:5px 0 0;font-size:0.8rem;color:rgba(255,255,255,0.7);}
    
    .sidebar-menu a, .sidebar-menu button{
      display:block;
      padding:12px;
      color:white;
      text-decoration:none;
      border-radius:5px;
      margin-bottom:10px;
      transition:background-color 0.2s;
      font-size:1rem;
      border:none;
      background:none;
      width:100%;
      text-align:left;
      cursor:pointer;
    }
    .sidebar-menu a:hover, .sidebar-menu button:hover, .menu-btn.active{
      background-color:var(--accent);
    }
    .sidebar-menu i{margin-right:10px;}
    
    .content{
      flex-grow:1;
      padding:40px;
    }
    .header-content{
      margin-bottom:40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #e9ecef;
      padding-bottom:20px;
    }
    .header-content h1{
      font-family:'Playfair Display', serif;
      color:var(--primary);
      margin:0;
      font-size:2.5rem;
    }
    .status-area{
      font-size:0.9rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:15px;
    }
    .card{
      background-color:var(--bg-card);
      padding:30px;
      border-radius:8px;
      box-shadow:var(--shadow-subtle);
      margin-bottom:30px;
    }
    h3{
      color:var(--primary);
      border-bottom:2px solid var(--accent);
      padding-bottom:10px;
      margin-top:0;
    }

    /* Tabs y Contenido */
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    /* Listas de Citas/Disponibilidad */
    .appointment-list{
      list-style:none;
      padding:0;
    }
    .appointment-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:15px;
      border-bottom:1px solid #eee;
    }
    .appointment-item:last-child{border-bottom:none;}
    .appointment-details h5{margin:0 0 5px;font-size:1.1rem;}
    .appointment-details p{margin:0;font-size:0.9rem;color:var(--muted);}
    
    .status-badge{
      padding:5px 10px;
      border-radius:4px;
      font-size:0.8rem;
      font-weight:700;
    }
    .status-available{background-color:#d4edda;color:var(--success);}
    .status-completed{background-color:#cce5ff;color:var(--info);}

    /* Botones de Acción */
    .btn-action{
      background-color:var(--accent);
      color:white;
      padding:8px 15px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-size:0.9rem;
      transition:background-color 0.2s;
      margin-left:10px;
    }
    .btn-action:hover{background-color:#5d8c6b;}
    .btn-secondary{background-color:var(--muted);}
    .btn-secondary:hover{background-color:#5a6268;}

    /* Formulario para agregar slot */
    #add-slot-form{
      display:flex;
      gap:15px;
      align-items:flex-end;
      margin-bottom:30px;
      border:1px solid #e9ecef;
      padding:20px;
      border-radius:8px;
    }
    #add-slot-form input{
      padding:10px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    #add-slot-form .form-group{
      flex:1;
    }
    #add-slot-form .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:700;
      font-size:0.9rem;
      color:var(--primary);
    }
    #add-slot-form button{
      flex:0 0 auto;
      height:40px;
      padding:0 20px;
    }
    
    /* Evolución Modal */
    #evolution-modal textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        margin-top: 5px;
        margin-bottom: 15px;
    }

    @media (max-width: 768px) {
        .wrapper { flex-direction: column; }
        .sidebar { width: 100%; position: relative; height: auto; }
        .content { padding: 20px; }
        .header-content { flex-direction: column; align-items: flex-start; }
        .header-content h1 { margin-bottom: 10px; font-size: 2rem; }
        .status-area { margin-top: 10px; }
    }
  </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="logo-text">Psicofitt Panel</div>
        <div class="profile-info">
            <h4 id="sidebar-name-el">Cargando...</h4>
            <p id="sidebar-sub-el">Estado: <span id="agenda-status">Desconectado</span></p>
        </div>

        <div class="sidebar-menu">
            <button class="menu-btn active" data-tab="agenda-tab"><i class="fas fa-calendar-check"></i> Citas de Hoy</button>
            <button class="menu-btn" data-tab="schedule-tab"><i class="fas fa-clock"></i> Horarios y Disponibilidad</button>
            <button class="menu-btn" data-tab="evolution-list-tab"><i class="fas fa-notes-medical"></i> Notas Clínicas (Historial)</button>
        </div>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
            <button id="logout-btn" style="background-color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
        </div>
    </div>

    <div class="content">
        <div class="header-content">
            <div>
                <h1 id="welcome-message">Bienvenido al Panel</h1>
                <p style="color:var(--muted); font-size:1.1rem;">Gestión de la Agenda: <span id="today-date-display"></span></p>
            </div>
            <div class="status-area">
                </div>
        </div>

        <div id="agenda-tab" class="tab-content active card">
            <h3><i class="fas fa-calendar-day"></i> Citas Agendadas para Hoy</h3>
            <ul class="appointment-list" id="today-appointments-list">
                <p style="color:var(--muted); font-style:italic;">Cargando...</p>
            </ul>
        </div>

        <div id="schedule-tab" class="tab-content card">
            <h3><i class="fas fa-plus-circle"></i> Agregar Nuevo Bloque de Disponibilidad</h3>
            <div id="add-slot-form">
                <div class="form-group">
                    <label for="new-date">Fecha</label>
                    <input type="date" id="new-date" required>
                </div>
                <div class="form-group">
                    <label for="new-time">Hora de Inicio</label>
                    <input type="time" id="new-time" required>
                </div>
                <button type="button" id="add-slot-btn" class="btn-action">Agregar Horario</button>
            </div>
            
            <h3><i class="fas fa-list-ul"></i> Horarios Disponibles Futuros</h3>
            <ul class="appointment-list" id="future-availability-list">
                <p style="color:var(--muted); font-style:italic;">Cargando...</p>
            </ul>
        </div>

        <div id="evolution-list-tab" class="tab-content card">
            <h3><i class="fas fa-file-medical-alt"></i> Historial de Evoluciones Clínicas</h3>
            <ul class="appointment-list" id="completed-evolutions-list">
                <p style="color:var(--muted); font-style:italic;">Cargando...</p>
            </ul>
        </div>
    </div>
</div>

<div id="evolution-modal-container"></div>

<script>
  // Configura tu cliente Supabase
  const supabaseUrl = 'https://sncznbowdiarakoekxit.supabase.co'; 
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuY3puYm93ZGlhcmFrb2VreGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTcwMTgsImV4cCI6MjA3NTkzMzAxOH0.X7hSM3_h0kPPpbxm-y7pbtOPXpnmk41uiwrN4lnGRJU'; 
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

  let currentProfessionalId = null;
  const todayDate = new Date().toISOString().split('T')[0];
  const todayDateDisplay = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('today-date-display').textContent = todayDateDisplay;

  // Elementos del DOM
  const welcomeMessage = document.getElementById('welcome-message');
  const sidebarNameEl = document.getElementById('sidebar-name-el');
  const sidebarSubEl = document.getElementById('sidebar-sub-el');
  const logoutBtn = document.getElementById('logout-btn');
  const agendaStatus = document.getElementById('agenda-status');
  const todayAppointmentsList = document.getElementById('today-appointments-list');
  const futureAvailabilityList = document.getElementById('future-availability-list');
  const completedEvolutionsList = document.getElementById('completed-evolutions-list');
  const evolutionModalContainer = document.getElementById('evolution-modal-container');
  const addSlotBtn = document.getElementById('add-slot-btn');

  
  /****************** Autenticación y Carga Inicial (Punto CLAVE) ******************/
  async function checkAuth() {
    agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--info)">Verificando...</span>';
    
    // 1. Verificar sesión activa
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session ? session.user : null;

    if (!user) {
      // Si no hay usuario, redirigir al login
      window.location.href = 'portal.html'; 
      return;
    }

    // 2. Cargar perfil del profesional
    // CRUCIAL: El ID del usuario autenticado DEBE ser el ID en la tabla 'profesionales'
    const { data: prof, error } = await supabaseClient
      .from('profesionales')
      .select('*')
      .eq('id', user.id) // <--- Usamos el UID de Supabase Auth para buscar en tu tabla 'profesionales'
      .single();

    if (error || !prof) {
      console.error('Error al obtener perfil del profesional:', error);
      welcomeMessage.textContent = 'Error al cargar perfil.';
      agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--danger)">Error de perfil. Verifique el ID en la tabla.</span>';
      // Forzar cierre de sesión si el perfil no existe o hay error
      await supabaseClient.auth.signOut();
      window.location.href = 'portal.html';
      return;
    }

    // 3. Establecer datos y cargar listas
    currentProfessionalId = prof.id;
    welcomeMessage.textContent = `¡Hola, ${prof.nombre || user.email}!`;
    sidebarNameEl.textContent = prof.nombre || user.email;
    sidebarSubEl.textContent = user.email || '';
    agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--success)">Conectado</span>';

    await loadTodayAppointments(); // Citas de hoy
    await loadFutureAvailability(); // Horarios disponibles
    await loadCompletedEvolutions(); // Historial de evoluciones
  }

  /****************** Citas de Hoy (agenda-tab) ******************/
  async function loadTodayAppointments() {
    todayAppointmentsList.innerHTML = '<p style="color:var(--muted); font-style:italic;">Cargando citas de hoy...</p>';

    const { data: appointments, error } = await supabaseClient
      .from('agendas')
      .select('*')
      .eq('profesional_id', currentProfessionalId)
      .eq('fecha', todayDate)
      .eq('disponible', false) // Solo citas tomadas
      .order('hora_inicio', { ascending: true });

    if (error) {
      console.error('Error al cargar citas de hoy:', error);
      todayAppointmentsList.innerHTML = '<p style="color:var(--danger);">Error al cargar las citas.</p>';
      return;
    }

    if (appointments.length === 0) {
      todayAppointmentsList.innerHTML = '<p style="color:var(--muted); font-style:italic;">No hay citas agendadas para hoy.</p>';
      return;
    }

    todayAppointmentsList.innerHTML = appointments.map(app => {
      const isCompleted = app.evolucion_registrada;
      return `
        <li class="appointment-item">
          <div class="appointment-details">
            <h5>${app.hora_inicio.substring(0, 5)} hrs. - ${app.paciente_nombre}</h5>
            <p>RUT: ${app.paciente_rut || 'N/A'} | Email: ${app.paciente_email}</p>
          </div>
          <div class="appointment-actions">
            ${isCompleted ? 
              `<span class="status-badge status-completed">Evolución Registrada</span>` :
              `<button class="btn-action" onclick="showEvolutionModal(${app.id}, '${app.paciente_nombre}', '${app.paciente_rut}', '${app.fecha}')">Registrar Evolución</button>`
            }
          </div>
        </li>
      `;
    }).join('');
  }

  /****************** Horarios Futuros Disponibles (schedule-tab) ******************/
  async function loadFutureAvailability() {
    futureAvailabilityList.innerHTML = '<p style="color:var(--muted); font-style:italic;">Cargando horarios...</p>';
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);

    const { data: slots, error } = await supabaseClient
      .from('agendas')
      .select('*')
      .eq('profesional_id', currentProfessionalId)
      .eq('disponible', true) // Solo slots disponibles
      .gte('fecha', tomorrow.toISOString().split('T')[0])
      .order('fecha', { ascending: true })
      .order('hora_inicio', { ascending: true });

    if (error) {
      console.error('Error al cargar disponibilidad futura:', error);
      futureAvailabilityList.innerHTML = '<p style="color:var(--danger);">Error al cargar horarios.</p>';
      return;
    }

    if (slots.length === 0) {
      futureAvailabilityList.innerHTML = '<p style="color:var(--muted); font-style:italic;">No hay horarios de agendamiento futuros. ¡Agrega algunos!</p>';
      return;
    }

    futureAvailabilityList.innerHTML = slots.map(slot => `
        <li class="appointment-item">
          <div class="appointment-details">
            <h5>${slot.fecha} a las ${slot.hora_inicio.substring(0, 5)} hrs.</h5>
            <p>Estado: <span class="status-badge status-available">Disponible</span></p>
          </div>
          <div class="appointment-actions">
            <button class="btn-action btn-secondary" style="background-color:var(--danger);" onclick="deleteSlot(${slot.id})">Eliminar</button>
          </div>
        </li>
      `).join('');
  }

  /****************** Gestión de Evoluciones (evolution-list-tab) ******************/
  async function loadCompletedEvolutions() {
    completedEvolutionsList.innerHTML = '<p style="color:var(--muted); font-style:italic;">Cargando historial de notas clínicas...</p>';

    const { data: evolutions, error } = await supabaseClient
      .from('evoluciones')
      .select('*')
      .eq('profesional_id', currentProfessionalId)
      .order('fecha_atencion', { ascending: false });

    if (error) {
      console.error('Error al cargar evoluciones:', error);
      completedEvolutionsList.innerHTML = '<p style="color:var(--danger);">Error al cargar historial.</p>';
      return;
    }

    if (evolutions.length === 0) {
      completedEvolutionsList.innerHTML = '<p style="color:var(--muted); font-style:italic;">Aún no has registrado ninguna evolución clínica.</p>';
      return;
    }

    completedEvolutionsList.innerHTML = evolutions.map(evo => `
        <li class="appointment-item" style="display:block;">
            <div style="border-left: 3px solid var(--primary); padding-left: 10px;">
                <h5>${evo.fecha_atencion} - Paciente: ${evo.paciente_nombre} (RUT: ${evo.paciente_rut})</h5>
                <p style="margin-top:5px; font-weight:700;">Diagnóstico (CIE-10): ${evo.diagnostico_cie || 'N/A'}</p>
                <p style="white-space: pre-wrap;"><strong>Evolución:</strong> ${evo.descripcion_evol}</p>
            </div>
        </li>
    `).join('');
  }

  /****************** Acciones CRUD y Modales ******************/

  // 1. Añadir Slot de Disponibilidad
  addSlotBtn.addEventListener('click', async () => {
    const date = document.getElementById('new-date').value;
    const time = document.getElementById('new-time').value;

    if (!date || !time) {
      alert('Debes seleccionar una fecha y hora.');
      return;
    }
    
    // El slot se inserta como disponible (disponible: true)
    const { error } = await supabaseClient
      .from('agendas')
      .insert({
        profesional_id: currentProfessionalId,
        fecha: date,
        hora_inicio: time,
        disponible: true
      });

    if (error) {
      console.error('Error al agregar slot:', error);
      alert('Error al agregar el horario. Verifica la consola.');
      return;
    }

    alert('Horario agregado con éxito para agendamiento público.');
    document.getElementById('new-date').value = '';
    document.getElementById('new-time').value = '';
    await loadFutureAvailability();
  });

  // 2. Eliminar Slot de Disponibilidad
  window.deleteSlot = async (slotId) => {
    if (!confirm('¿Estás seguro de que quieres eliminar este bloque de disponibilidad?')) return;

    const { error } = await supabaseClient
      .from('agendas')
      .delete()
      .eq('id', slotId)
      .eq('disponible', true); // Solo permite borrar si está disponible

    if (error) {
      console.error('Error al eliminar slot:', error);
      alert('Error al eliminar. Asegúrate de que no es una cita ya tomada.');
      return;
    }
    
    alert('Bloque eliminado.');
    await loadFutureAvailability();
  }

  // 3. Mostrar Modal de Evolución
  window.showEvolutionModal = function(agendaId, pacienteNombre, pacienteRut, fechaAtencion) {
    evolutionModalContainer.innerHTML = `
        <div id="evolution-modal" class="card" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; width:90%; max-width:600px; padding:30px; border:2px solid var(--accent);">
            <h3 style="color:var(--primary); margin-top:0;">Registro de Evolución Clínica</h3>
            <p><strong>Cita:</strong> ${pacienteNombre} (${fechaAtencion})</p>
            <form id="evolution-form">
                <input type="hidden" id="modal-agenda-id" value="${agendaId}">
                <input type="hidden" id="modal-paciente-nombre" value="${pacienteNombre}">
                <input type="hidden" id="modal-paciente-rut" value="${pacienteRut}">
                <input type="hidden" id="modal-fecha-atencion" value="${fechaAtencion}">

                <div style="margin-bottom:15px;">
                    <label for="diagnostico_cie">Diagnóstico Principal (CIE-10 o similar)</label>
                    <input type="text" id="diagnostico_cie" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                </div>

                <label for="descripcion_evol">Nota Clínica / Evolución (*)</label>
                <textarea id="descripcion_evol" rows="10" required placeholder="Describe la sesión, intervenciones y plan a seguir."></textarea>
                
                <div id="evolution-status" style="margin-bottom:15px; font-weight:bold;"></div>

                <button type="submit" class="btn-action">Guardar Evolución</button>
                <button type="button" onclick="document.getElementById('evolution-modal').remove()" class="btn-action btn-secondary">Cerrar</button>
            </form>
        </div>
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="document.getElementById('evolution-modal').remove()"></div>
    `;
    document.getElementById('evolution-modal').querySelector('form').addEventListener('submit', handleEvolutionSubmit);
  }

  // 4. Manejar el envío del Formulario de Evolución
  async function handleEvolutionSubmit(e) {
    e.preventDefault();
    const modal = document.getElementById('evolution-modal');
    const statusEl = document.getElementById('evolution-status');
    statusEl.textContent = 'Guardando datos...';
    statusEl.style.color = 'var(--accent)';

    const agendaId = document.getElementById('modal-agenda-id').value;
    const pacienteNombre = document.getElementById('modal-paciente-nombre').value;
    const pacienteRut = document.getElementById('modal-paciente-rut').value;
    const fechaAtencion = document.getElementById('modal-fecha-atencion').value;
    const descripcionEvol = document.getElementById('descripcion_evol').value;
    const diagnosticoCIE = document.getElementById('diagnostico_cie').value;

    if (!descripcionEvol) {
        statusEl.textContent = 'La nota clínica no puede estar vacía.';
        statusEl.style.color = 'var(--danger)';
        return;
    }

    try {
        // 1. Insertar en la tabla evoluciones
        const { error: insertError } = await supabaseClient
            .from('evoluciones')
            .insert({
                profesional_id: currentProfessionalId,
                paciente_rut: pacienteRut,
                paciente_nombre: pacienteNombre,
                fecha_atencion: fechaAtencion,
                descripcion_evol: descripcionEvol,
                diagnostico_cie: diagnosticoCIE
            });

        if (insertError) throw insertError;

        // 2. Marcar la cita como evolucion_registrada: true en la tabla agendas
        const { error: updateError } = await supabaseClient
            .from('agendas')
            .update({ evolucion_registrada: true })
            .eq('id', agendaId);

        if (updateError) throw updateError;
        
        // Éxito
        statusEl.textContent = 'Evolución guardada con éxito.';
        statusEl.style.color = 'var(--success)';

        // Recargar las listas
        await loadTodayAppointments();
        await loadCompletedEvolutions();

        // Cerrar modal después de un breve delay
        setTimeout(() => modal.remove(), 1000);

    } catch (error) {
        console.error('Error al guardar evolución:', error);
        statusEl.textContent = `Error al guardar. (${error.message})`;
        statusEl.style.color = 'var(--danger)';
    }
  }

  // 5. Logout
  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'portal.html';
  });

  // 6. Tabs UI
  document.querySelectorAll('.menu-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      if (tab) document.getElementById(tab).classList.add('active');
    });
  });

  // 7. Inicializar
  document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
  });
</script>
</body>
</html>
