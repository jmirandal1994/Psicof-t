<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel de Control | Psicofitt</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    /* ---------- Estilos Base y Paleta ---------- */
    :root{
      --primary:#2C3A47; /* Gris Azulado Oscuro (Headers/Textos) */
      --accent:#B8860B; /* Ocre Suave/Bronce (Acción/Énfasis) */
      --bg:#f8f9fa; /* Fondo General */
      --muted:#6c757d;
      --success: #1e7e34; 
      --danger: #d9534f;
      --info: #007bff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:#495057;
      margin:0;
      min-height:100vh;
      display:flex;
    }

    /* Sidebar (Menú Lateral) */
    .sidebar{
      width:250px;
      background:var(--primary);
      color:white;
      padding:20px;
      flex-shrink:0;
      height:100vh;
      position:sticky;
      top:0;
      box-shadow:2px 0 5px rgba(0,0,0,0.2);
    }
    .sidebar h2{
      font-family:'Playfair Display',serif;
      font-size:1.8rem;
      margin-bottom:30px;
      text-align:center;
    }
    .profile-info{margin-bottom:30px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:15px;}
    #sidebar-name{font-weight:700;font-size:1.1rem;display:block;}
    #sidebar-sub{font-size:0.9rem;opacity:0.8;}

    .menu-btn{
      display:block;
      padding:12px 15px;
      margin-bottom:10px;
      color:white;
      text-decoration:none;
      border-radius:6px;
      transition:background 0.2s;
      cursor:pointer;
      font-weight:500;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .menu-btn:hover{background:rgba(255,255,255,0.1);}
    .menu-btn.active{background:var(--accent);font-weight:700;}
    .menu-btn i{margin-right:10px;}

    #logout-btn{
      margin-top:20px;
      background:var(--danger);
      text-align:center;
      border:none;
      cursor:pointer;
      font-weight:700;
      color:white;
      padding:10px;
      border-radius:6px;
    }

    /* Contenido Principal */
    .main-content{
      flex-grow:1;
      padding:30px;
    }
    .header-content{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:30px;
      border-bottom:2px solid #ddd;
      padding-bottom:15px;
    }
    .header-content h1{
      font-family:'Playfair Display',serif;
      color:var(--primary);
      margin:0;
    }
    #welcome-message{font-size:1.5rem;font-weight:700;}
    #agenda-status{font-size:0.9rem;}

    /* Contenido de Tabs */
    .tab-content{display:none; padding-top: 10px;}
    .tab-content.active{display:block;}

    /* Listas de Citas (Citas Hoy) */
    .appointment-list .card{
      background:white;
      padding:15px;
      margin-bottom:15px;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      border-left:5px solid var(--accent);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .appointment-list .card-body{flex-grow:1;}
    .appointment-list .time{
      font-weight:700;
      color:var(--primary);
      font-size:1.2rem;
      margin-bottom:5px;
    }
    .appointment-list .name{font-weight:500;}
    .appointment-list .action-btn{
      background:var(--success);
      color:white;
      padding:8px 12px;
      border-radius:4px;
      text-decoration:none;
      font-size:0.9rem;
      cursor:pointer;
      border:none;
    }
    .appointment-list .action-btn:hover{opacity:0.9;}

    /* Modal (Para Evolución) */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:1000;
    }
    .modal-content{
      background:white;
      padding:30px;
      border-radius:8px;
      width:90%;
      max-width:600px;
      box-shadow:0 5px 15px rgba(0,0,0,0.3);
      position:relative;
    }
    .modal-content h3{
      font-family:'Playfair Display',serif;
      color:var(--primary);
      margin-top:0;
    }
    .modal-content textarea{
      width:100%;
      padding:10px;
      margin-bottom:15px;
      border:1px solid #ddd;
      border-radius:4px;
    }
    .modal-content button{
      padding:10px 15px;
      border:none;
      border-radius:4px;
      cursor:pointer;
      font-weight:700;
    }
    .modal-content .close-btn{
      position:absolute;
      top:10px;
      right:10px;
      background:none;
      font-size:1.5rem;
      color:var(--muted);
    }
    .modal-content .save-btn{background:var(--accent);color:white;}
    .modal-content .cancel-btn{background:#eee;margin-right:10px;}

    /* --- CALENDARIO DE TABLA (VISTA SEMANAL) --- */
    .calendar-table{border-collapse:collapse;width:100%;min-width:700px; margin-top: 20px; font-size: 0.9rem;} 
    .calendar-table thead th{
        position:sticky;top:0;
        background:var(--primary);
        color:white;
        border-bottom:1px solid #e9ecef;
        padding:10px 8px;
        text-align:center;
        font-weight:700;
        cursor:pointer; 
        width: 10%;
    } 
    .time-col{
        width:80px;
        text-align:center;
        padding:10px 5px;
        background:var(--bg);
        font-weight:700;
        color:var(--primary);
        border-right:1px solid #e9ecef
    } 
    .calendar-table td{height:50px;padding:6px; border: 1px solid #eee; background-color: white;}
    .cell{
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:6px;
        cursor:pointer;
        user-select:none;
        transition:background .2s, border-color .2s;
        font-weight:500;
        height:100%;
        width:100%;
        font-size: 0.85rem;
    }
    .cell.available{background:#fff;border:1px solid var(--accent);color:var(--accent);}
    .cell.available:hover{background:var(--accent);color:#fff;}
    .cell.booked{background:var(--danger);color:#fff;cursor:not-allowed;} 
    .cell.set-available{background:var(--success);color:#fff;border:1px solid var(--success);} /* Estado que la profesional marca como disponible */
    .cell.set-available:hover{background:var(--accent);border-color:var(--accent);}

    .calendar-wrapper { overflow-x: auto; border-radius: 12px; border: 1px solid #e9ecef; background: #fff; padding: 12px; }
    .week-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
    .week-label{font-weight:700;color:var(--primary);font-size:1.05rem}

    .btn-nav{background:#fff;color:var(--primary);border:1px solid #e9ecef;padding:8px 12px;cursor:pointer;font-weight:700;border-radius: 6px; transition: background-color 0.2s;}
    .btn-nav:hover{background-color: #eee;}

    /* Historial */
    .evolution-list .card{border-left:5px solid var(--success);}
    .evolution-list .card-body .name{color:var(--success);}
    .evolution-list .action-btn{background:var(--info);}

    /* Utilitarios */
    .mt-3{margin-top:1rem;}
    .mb-3{margin-bottom:1rem;}
    .p-3{padding:1rem;}

    /* Mensaje de error visual */
    .error-box{background:#fff0f0;border:1px solid #ffd6d6;color:#7a1f1f;padding:12px;border-radius:8px;margin:10px 0}
    .hint-box{background:#f8fbff;border:1px solid #e2f0ff;color:#1b4f8a;padding:12px;border-radius:8px;margin:10px 0}

    /* Spinner sencillo */
    .spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Responsividad (Móvil/Tablet) */
    @media (max-width:900px){
      .main-content {
          flex-direction: column; /* Apila las columnas */
          gap: 20px;
          padding: 20px;
      }
      .calendar-table{min-width:600px;}
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2><i class="fas fa-brain"></i> Psicofitt Panel</h2>
    <div class="profile-info">
      <span id="sidebar-name">Cargando...</span>
      <span id="sidebar-sub"></span>
    </div>
    
    <button data-tab="tab-today" class="menu-btn active"><i class="fas fa-calendar-day"></i> Citas de Hoy</button>
    <button data-tab="tab-schedule" class="menu-btn"><i class="fas fa-calendar-alt"></i> Agenda de la Semana</button>
    <button data-tab="tab-history" class="menu-btn"><i class="fas fa-history"></i> Historial de Evoluciones</button>

    <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
  </div>

  <div class="main-content">
    
    <div class="header-content">
      <h1 id="welcome-message">Bienvenida al Panel</h1>
      <span id="agenda-status">Estado: <span style="font-weight:700;color:var(--info)">Verificando...</span></span>
    </div>

    <div id="tab-today" class="tab-content active">
      <h3 class="mb-3">Citas Pendientes para Hoy</h3>
      <div id="appointments-today" class="appointment-list">
        <p>Cargando citas...</p>
      </div>
      <div id="no-appointments-today" style="display:none; padding:20px; background:#fff; border:1px solid #eee; border-radius:6px;">
        <i class="fas fa-check-circle" style="color:var(--success);"></i> No hay citas pendientes para hoy.
      </div>
    </div>

    <div id="tab-schedule" class="tab-content">
        <h3 class="mb-3">Gestión de Disponibilidad Semanal</h3>
        <p style="font-size: 0.95rem; color: var(--muted); margin-bottom: 25px;">
            Haz clic en una celda **vacía** para marcarla como **Disponible** (<span style="color:var(--accent); font-weight:700;">Ocre</span>) o haz clic en una celda disponible para **Bloquearla** (<span style="color:var(--primary); font-weight:700;">Gris Azulado</span>). Los horarios en <span style="color:var(--danger); font-weight:700;">Rojo</span> ya reservados no pueden modificarse.
        </p>
        
        <div class="week-controls">
            <div style="display:flex;gap:8px;align-items:center">
                <button id="prev-week" class="btn-nav" onclick="changeWeek(-7)">
                    <i class="fas fa-chevron-left"></i> Semana anterior
                </button>
                <button id="next-week" class="btn-nav" onclick="changeWeek(7)">
                    Semana siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div style="display:flex;align-items:center;gap:18px">
                <div class="week-label" id="week-label">Cargando semana...</div>
            </div>
        </div>
        
        <div class="calendar-wrapper">
            <table class="calendar-table" aria-label="Calendario semanal">
                <thead>
                    <tr id="calendar-head">
                        <th class="time-col">Hora</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    </tbody>
            </table>
        </div>
    </div>


    <div id="tab-history" class="tab-content">
      <h3 class="mb-3">Historial de Evoluciones Registradas</h3>
      <div id="evolutions-history" class="evolution-list">
        <p>Cargando historial...</p>
      </div>
       <div id="no-history" style="display:none; padding:20px; background:#fff; border:1px solid #eee; border-radius:6px;">
        <i class="fas fa-info-circle" style="color:var(--info);"></i> Aún no hay evoluciones registradas.
      </div>
    </div>
    
  </div> <script>
  // --- CREDENCIALES DE SUPABASE ---
  const supabaseUrl = 'https://sncznbowdiarakoekxit.supabase.co'; 
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuY3puYm93ZGlhcmFrb2VreGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTcwMTgsImV4cCI6MjA3NTkzMzAxOH0.X7hSM3_h0kPPpbxm-y7pbtOPXpnmk41uiwrN4lnGRJU'; 
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

  // --- ESTADO GLOBAL ---
  let currentProfessionalId = null;
  let currentWeekStart = new Date(); 
  let agendaMap = new Map();
  const startHour = 9, endHour = 18, slotIntervalMin = 45; 
  let timeSlots = [];
  
  const welcomeMessage = document.getElementById('welcome-message');
  const sidebarNameEl = document.getElementById('sidebar-name');
  const sidebarSubEl = document.getElementById('sidebar-sub');
  const agendaStatus = document.getElementById('agenda-status');
  const logoutBtn = document.getElementById('logout-btn');


  // --- UTILIDADES DE TIEMPO ---
  function pad(n){ return String(n).padStart(2,'0'); }
  function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  function getStartOfWeek(date){
    const d = new Date(date);
    const day = d.getDay(); 
    const diff = (day === 0 ? -6 : 1) - day; 
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  currentWeekStart = getStartOfWeek(currentWeekStart); 

  function generateTimeSlots(){
      timeSlots = [];
      const temp = new Date();
      temp.setHours(startHour,0,0,0);
      while (temp.getHours() < endHour || (temp.getHours() === endHour && temp.getMinutes() === 0)) {
          const t = `${pad(temp.getHours())}:${pad(temp.getMinutes())}`;
          timeSlots.push(t);
          temp.setMinutes(temp.getMinutes() + slotIntervalMin);
      }
      if (timeSlots.length > 0) {
          const lastSlotTime = timeSlots[timeSlots.length - 1];
          const [h, m] = lastSlotTime.split(':').map(Number);
          if (h > endHour || (h === endHour && m > 0)) {
              timeSlots.pop();
          }
      }
  }
  generateTimeSlots();

  /****************** 1. AUTENTICACIÓN Y CARGA INICIAL (CORREGIDO) ******************/
  async function checkAuth() {
    agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--info)">Verificando...</span>';
    
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        const user = session ? session.user : null;

        if (!user) {
            window.location.href = 'portal.html';
            return;
        }

        const loggedInUserId = user.id;
        console.log("--- DEBUG DE AUTENTICACIÓN ---");
        console.log("1. Usuario logeado. UID de Supabase Auth:", loggedInUserId);


        // Cargar perfil del profesional usando el UID logeado
        const { data: prof, error } = await supabaseClient
            .from('profesionales')
            .select('*')
            .eq('id', loggedInUserId) 
            .maybeSingle(); // Usamos maybeSingle para manejar el caso de no encontrar la fila sin lanzar error

        console.log("2. Resultado de búsqueda en tabla 'profesionales':", prof);
        console.log("3. Error de Supabase (si existe):", error);


        if (error || !prof) {
            let debugMessage = "No se encontró perfil en tabla 'profesionales'.";
            if (error && error.code === 'PGRST116') {
                debugMessage = "Error: Múltiples perfiles con el mismo ID. ¡Revisar tabla!";
            } else if (error) {
                debugMessage = `Error de DB (${error.code}): ${error.message}`;
            }
            
            console.error(debugMessage);

            // Mostrar mensaje de error en el panel
            document.querySelector('.main-content').innerHTML = `
                <div style="background:#fff3f4; border:1px solid var(--danger); padding:25px; border-radius:8px; margin-top:30px;">
                    <h2>⚠️ Error Crítico: Perfil No Sincronizado ⚠️</h2>
                    <p>El panel no pudo inicializar porque la fila de su perfil en la tabla <b>'profesionales'</b> (columna ID) no coincide con su usuario de inicio de sesión (UID).</p>
                    <p><b>UID REQUERIDO:</b></p>
                    <pre style="background:#eee; padding:10px; word-break:break-all; font-weight:700;">${loggedInUserId}</pre>
                    <p>Pegue este ID en la tabla y **luego actualice la página**.</p>
                </div>
            `;
            return;
        }

        // Carga exitosa
        currentProfessionalId = prof.id;
        welcomeMessage.textContent = `¡Hola, ${prof.nombre || user.email}!`;
        sidebarNameEl.textContent = prof.nombre || user.email;
        sidebarSubEl.textContent = user.email || 'N/D';

        // Carga de datos
        setTimeout(async () => {
            await loadTodayAppointments(); 
            await loadWeekSchedule(); // Cargar la agenda semanal
            await loadCompletedEvolutions(); 
            agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--success)">Conectado</span>';
        }, 50);

    } catch (err) {
        console.error('checkAuth error (fatal):', err);
        await supabaseClient.auth.signOut();
        window.location.href = 'portal.html';
    }
  }

  /****************** 2. CALENDARIO SEMANAL (GESTIÓN DE DISPONIBILIDAD) ******************/
  async function loadWeekSchedule() {
      if (!currentProfessionalId) return;

      const start = toISODate(currentWeekStart);
      const end = toISODate(addDays(currentWeekStart, 6));
      
      document.getElementById('week-label').textContent = `${start} — ${end}`;
      
      const { data, error } = await supabaseClient
          .from('agendas')
          .select('id, fecha, hora_inicio, disponible, paciente_nombre')
          .eq('profesional_id', currentProfessionalId)
          .gte('fecha', start)
          .lte('fecha', end);

      if (error) {
          console.error('Error al cargar agenda:', error);
          document.getElementById('calendar-body').innerHTML = '<tr><td colspan="8">Error al cargar la agenda.</td></tr>';
          return;
      }

      agendaMap.clear();
      (data || []).forEach(item => {
          const hora = item.hora_inicio.substring(0, 5);
          const key = `${item.fecha}|${hora}`;
          agendaMap.set(key, item);
      });
      
      renderCalendarTable();
  }

  function renderCalendarTable() {
      const calendarHead = document.getElementById('calendar-head');
      const calendarBody = document.getElementById('calendar-body');
      
      // 1. Renderizar encabezados de días
      calendarHead.querySelectorAll('th:not(.time-col)').forEach(n => n.remove());
      const dayNames = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];

      for (let i = 0; i < 7; i++) {
          const d = addDays(currentWeekStart, i);
          const th = document.createElement('th');
          th.innerHTML = `<div style="font-weight:700">${dayNames[i]}</div><div style="font-size:0.85rem;color:var(--accent)">${d.getDate()}/${pad(d.getMonth() + 1)}</div>`;
          calendarHead.appendChild(th);
      }

      // 2. Renderizar filas por horario
      calendarBody.innerHTML = '';
      const today = toISODate(new Date());

      for (const time of timeSlots) {
          const tr = document.createElement('tr');
          const tdTime = document.createElement('td');
          tdTime.className = 'time-col';
          tdTime.textContent = time;
          tr.appendChild(tdTime);

          for (let i = 0; i < 7; i++) {
              const d = addDays(currentWeekStart, i);
              const dateStr = toISODate(d);
              const key = `${dateStr}|${time}`;
              const record = agendaMap.get(key);
              
              const isPast = d < new Date(new Date().setHours(0,0,0,0));
              const isBooked = record && record.disponible === false;
              const isAvailable = record && record.disponible === true;
              
              const td = document.createElement('td');
              const cell = document.createElement('div');
              cell.className = 'cell';
              
              if (isPast) {
                  cell.innerHTML = 'Pasado';
                  cell.style.backgroundColor = '#eee';
                  cell.style.color = var(--muted);
                  cell.style.cursor = 'not-allowed';
              } else if (isBooked) {
                  cell.classList.add('booked');
                  cell.innerHTML = `Reservado: ${record.paciente_nombre || 'Paciente'}`;
                  cell.title = 'Ya reservado. No se puede modificar.';
                  cell.style.cursor = 'not-allowed';
              } else if (isAvailable) {
                  cell.classList.add('set-available'); // CAMBIO DE CLASE A set-available (Verde)
                  cell.innerHTML = 'DISPONIBLE';
                  cell.title = 'Clic para bloquear';
                  cell.dataset.action = 'mark-unavailable';
                  cell.dataset.agendaId = record.id;
                  cell.addEventListener('click', () => markAvailable(cell, false));
              } else {
                  // Slot no existe en la DB (o disponible=null), se puede crear
                  cell.classList.add('available'); // CAMBIO DE CLASE A available (Ocre/Accent)
                  cell.innerHTML = 'BLOQUEADO';
                  cell.title = 'Clic para marcar como DISPONIBLE';
                  cell.dataset.action = 'mark-available';
                  cell.dataset.date = dateStr;
                  cell.dataset.time = time;
                  cell.addEventListener('click', () => markAvailable(cell, true));
              }

              td.appendChild(cell);
              tr.appendChild(td);
          }
          calendarBody.appendChild(tr);
      }
  }

  function changeWeek(direction) {
      currentWeekStart = addDays(currentWeekStart, direction);
      loadWeekSchedule();
  }

  async function markAvailable(cell, newStatus) {
      const statusText = newStatus ? 'Disponible' : 'No Disponible';
      const originalHTML = cell.innerHTML;
      cell.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Guardando...`;
      cell.style.cursor = 'wait';
      
      let recordId = cell.dataset.agendaId;

      try {
          if (newStatus) {
              // CREAR O MARCAR COMO DISPONIBLE
              if (!recordId) {
                  const dateStr = cell.dataset.date;
                  const timeStr = cell.dataset.time;
                  
                  const { data: insertData, error: insertError } = await supabaseClient
                      .from('agendas')
                      .insert({
                          profesional_id: currentProfessionalId,
                          fecha: dateStr,
                          hora_inicio: timeStr,
                          disponible: true,
                      }).select('id').single(); 
                  
                  if (insertError) throw insertError;
                  cell.dataset.agendaId = insertData.id; 
              } else {
                  // Actualizar a Disponible
                  await supabaseClient
                      .from('agendas')
                      .update({ disponible: true, paciente_nombre: null }) // Limpiar datos de paciente al poner disponible
                      .eq('id', recordId);
              }
          } else {
              // MARCAR COMO NO DISPONIBLE (Bloquear)
              await supabaseClient
                  .from('agendas')
                  .update({ 
                      disponible: false, 
                      paciente_nombre: 'BLOQUEADO' // Marcar para que se distinga de una reserva real
                  })
                  .eq('id', recordId);
          }
          
          loadWeekSchedule(); // Refrescar el calendario
      } catch (error) {
          console.error(`Error al marcar como ${statusText}:`, error);
          alert(`Error al guardar: ${error.message}.`);
          cell.innerHTML = originalHTML;
          cell.style.cursor = 'pointer';
      }
  }

  /****************** 3. CITAS DE HOY ******************/
  async function loadTodayAppointments() {
    // ... (Esta función se mantiene igual) ...
    if (!currentProfessionalId) return;

    const today = toISODate(new Date());
    const container = document.getElementById('appointments-today');
    const noAppts = document.getElementById('no-appointments-today');
    container.innerHTML = 'Cargando...';
    
    const { data: appointments, error } = await supabaseClient
        .from('agendas')
        .select('*')
        .eq('profesional_id', currentProfessionalId)
        .eq('fecha', today)
        .eq('disponible', false) // Solo citas reservadas
        .order('hora_inicio', { ascending: true });

    if (error) {
        console.error('Error al cargar citas de hoy:', error);
        container.innerHTML = 'Error al cargar las citas.';
        return;
    }

    if (appointments.length === 0) {
        container.style.display = 'none';
        noAppts.style.display = 'block';
        return;
    }

    noAppts.style.display = 'none';
    container.style.display = 'block';
    
    container.innerHTML = appointments.map(appt => `
        <div class="card" data-agenda-id="${appt.id}" data-paciente="${appt.paciente_nombre}">
            <div class="card-body">
                <div class="time">${appt.hora_inicio.substring(0, 5)} hrs</div>
                <div class="name">${appt.paciente_nombre} - ${appt.paciente_prevision || 'Particular'}</div>
                <div style="font-size:0.85rem; color:var(--muted); margin-top:5px;">
                  Email: ${appt.paciente_email} | Tel: ${appt.paciente_celular}
                </div>
            </div>
            <button class="action-btn" onclick="openEvolutionModal(${appt.id}, '${appt.paciente_nombre}')">
                <i class="fas fa-file-medical"></i> Registrar Evolución
            </button>
        </div>
    `).join('');
  }

  /****************** 4. MODAL Y EVOLUCIÓN ******************/
  function openEvolutionModal(agendaId, pacienteNombre) {
      // ... (Esta función se mantiene igual) ...
      const modalHTML = `
          <div class="modal-overlay" id="evolution-modal">
              <div class="modal-content">
                  <button class="close-btn" onclick="document.getElementById('evolution-modal').remove()">&times;</button>
                  <h3>Evolución de Sesión con ${pacienteNombre}</h3>
                  <textarea id="evolution-text" rows="8" placeholder="Escribe aquí las notas de la evolución, diagnóstico y plan..."></textarea>
                  
                  <div id="modal-status-message" class="mb-3" style="font-weight:700;"></div>

                  <button class="cancel-btn" onclick="document.getElementById('evolution-modal').remove()">Cancelar</button>
                  <button class="save-btn" onclick="saveEvolution('${agendaId}')">Guardar Evolución</button>
              </div>
          </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  async function saveEvolution(agendaId) {
       // ... (Esta función se mantiene igual) ...
      const evolutionText = document.getElementById('evolution-text').value;
      const statusEl = document.getElementById('modal-status-message');
      const modal = document.getElementById('evolution-modal');

      if (!evolutionText.trim()) {
          statusEl.textContent = 'La evolución no puede estar vacía.';
          statusEl.style.color = var(--danger);
          return;
      }

      statusEl.textContent = 'Guardando...';
      statusEl.style.color = var(--info);

      try {
          // 1. Insertar la evolución
          const { error: insertError } = await supabaseClient
              .from('evoluciones')
              .insert({
                  agenda_id: agendaId,
                  notas: evolutionText,
                  fecha: toISODate(new Date()) 
              });

          if (insertError) throw insertError;
          
          // 2. Marcar la cita como evolucionada
          const { error: updateError } = await supabaseClient
              .from('agendas')
              .update({ evolucion_registrada: true })
              .eq('id', agendaId);

          if (updateError) throw updateError;
          
          // Éxito
          statusEl.textContent = 'Evolución guardada con éxito.';
          statusEl.style.color = var(--success);

          // Recargar las listas
          await loadTodayAppointments();
          await loadCompletedEvolutions();

          // Cerrar modal después de un breve delay
          setTimeout(() => modal.remove(), 1000);

      } catch (error) {
          console.error('Error al guardar evolución:', error);
          statusEl.textContent = `Error al guardar. (${error.message})`;
          statusEl.style.color = var(--danger);
      }
  }

  /****************** 5. HISTORIAL DE EVOLUCIONES ******************/
  async function loadCompletedEvolutions() {
      // ... (Esta función se mantiene igual) ...
      if (!currentProfessionalId) return;

      const container = document.getElementById('evolutions-history');
      const noHistory = document.getElementById('no-history');
      container.innerHTML = 'Cargando historial...';

      // Unir evoluciones con la información de la agenda (paciente)
      const { data: evolutions, error } = await supabaseClient
          .from('evoluciones')
          .select(`
              *,
              agendas (paciente_nombre, fecha)
          `)
          .order('fecha', { ascending: false });

      if (error) {
          console.error('Error al cargar historial:', error);
          container.innerHTML = 'Error al cargar el historial.';
          return;
      }
      
      const filteredEvolutions = evolutions.filter(evo => evo.agendas);

      if (filteredEvolutions.length === 0) {
          container.style.display = 'none';
          noHistory.style.display = 'block';
          return;
      }

      noHistory.style.display = 'none';
      container.style.display = 'block';

      container.innerHTML = filteredEvolutions.map(evo => `
          <div class="card">
              <div class="card-body">
                  <div class="time">${evo.agendas.fecha}</div>
                  <div class="name">${evo.agendas.paciente_nombre}</div>
                  <div style="font-size:0.9rem; color:var(--muted); margin-top:5px;">
                    Notas: ${evo.notas.substring(0, 80)}...
                  </div>
              </div>
              <button class="action-btn" onclick="alert('Evolución Completa:\\n${evo.notas.replace(/'/g, "\\'")}')">
                  <i class="fas fa-eye"></i> Ver Notas
              </button>
          </div>
      `).join('');
  }

  /****************** 6. LOGOUT Y TABS ******************/
  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'portal.html';
  });

  document.querySelectorAll('.menu-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      if (tab) document.getElementById(tab).classList.add('active');
    });
  });

  /****************** Inicializar ******************/
  document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
  });

</script>
</body>
</html>
