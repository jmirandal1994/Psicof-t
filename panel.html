<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel de Control | Speech Psychology</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    /* ---------- Estilos (preservados + mejoras) ---------- */
    :root{
      --primary:#2b3a67;
      --accent:#e0a35e;
      --bg:#f8f9fa;
      --muted:#6c757d;
      --success: #1e7e34; /* Verde para citas/confirmaci√≥n */
      --danger: #d9534f; /* Rojo para pendiente/alerta */
    }
    *{box-sizing:border-box}
    body{
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:#495057;
      margin:0;
      display:flex;
      min-height:100vh;
    }

    /* ---------------------------------------------------- */
    /* SIDEBAR                      */
    /* ---------------------------------------------------- */
    .sidebar{
      width:280px;
      background:#fff;
      padding:30px;
      box-shadow:2px 0 10px rgba(0,0,0,0.05);
      display:flex;
      flex-direction:column;
      align-items:center;
      flex-shrink: 0; /* Evita que se encoja en escritorio */
      position: sticky; /* Fijo en escritorio */
      top: 0;
      height: 100vh;
    }
    .profile-pic{width:150px;height:150px;border-radius:50%;background:#e9ecef;margin-bottom:20px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .profile-pic img{width:100%;height:100%;object-fit:cover}
    .sidebar h4{font-family:'Playfair Display',serif;color:var(--primary);margin-bottom:14px}
    .sidebar .small-muted{color:var(--muted);font-size:0.95rem;margin-bottom:18px}

    .sidebar-menu{list-style:none;padding:0;width:100%}
    .sidebar-menu li{margin-bottom:10px}
    .sidebar-menu button{
      background:transparent;border:none;width:100%;text-align:left;padding:12px 16px;border-radius:8px;font-weight:700;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:12px
    }
    .sidebar-menu button.active,.sidebar-menu button:hover{background:var(--accent);color:#fff}
    .sidebar-menu button i{color:var(--primary)}
    .sidebar-menu button.active i{color:#fff}

    /* ---------------------------------------------------- */
    /* MAIN CONTENT                   */
    /* ---------------------------------------------------- */
    .main-content{
        flex: 1;
        padding: 40px;
        display: flex; 
        gap: 30px; 
    }
    
    .agenda-area {
        flex: 2.5; 
        display: flex;
        flex-direction: column;
    }

    .sidebar-reservas {
        flex: 1; 
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        min-width: 250px; 
        max-height: calc(100vh - 80px); 
        overflow-y: auto;
    }
    
    /* RESERVAS Y EVOLUCIONES */
    .reserva-list { list-style:none; padding:0; margin:0; }
    .reserva-item { background:#f8f9fa; border:1px solid #e9ecef; padding:15px; margin-bottom:10px; border-radius:8px; cursor:pointer; transition:background 0.2s; }
    .reserva-item:hover { background:#e9ecef; }
    .reserva-time { font-weight:700; color:var(--primary); display:block; margin-bottom:5px; }
    .reserva-details { font-size:0.9rem; color:var(--muted); }
    .reserva-details strong { color:var(--success); }
    
    .pending-item { background:#fffafa; border:1px solid #ffeded; border-left:5px solid var(--danger); padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; transition:all 0.3s ease-out; }
    .pending-item button { background:var(--success); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.9rem; white-space:nowrap; font-weight:600; }
    .pending-item-info { max-width:70%; }
    .pending-item .reserva-time { color:var(--danger); }
    
    .header-panel{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid #e9ecef}
    .header-panel h2{font-family:'Playfair Display',serif;color:var(--primary);font-size:2.2rem;margin:0}
    .logout-btn{background:var(--accent);color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:700}

    .tab-content{display:none;background:#fff;padding:36px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,0.08);margin-bottom:18px}
    .tab-content.active{display:block}

    /* CALENDARIO ESTILOS */
    .week-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
    .calendar-wrapper{overflow-x: auto;border-radius:12px;border:1px solid #e9ecef;background:#fff;padding:12px} 
    .calendar-table{border-collapse:collapse;width:100%;min-width:700px} /* Min width para escritorio */
    
    .time-col{width:80px;text-align:left;padding-left:12px;background:#fafafa;position:sticky;left:0;z-index:2;font-weight:700;color:var(--primary);border-right:1px solid #e9ecef} 
    /* Estilos de Celda (se mantiene la base) */
    .calendar-table td{height:56px;padding:6px}
    .cell{display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;user-select:none;font-weight:700;height:100%;width:100%}

    /* ---------------------------------------------------- */
    /* RESPONSIVIDAD M√ìVIL (<= 900px)     */
    /* ---------------------------------------------------- */
    
    @media (max-width:900px){
      /* Estructura Principal */
      body {
        flex-direction: column;
      }
      .main-content {
          flex-direction: column; /* Apila las columnas */
          padding: 15px;
          gap: 15px;
      }

      /* Sidebar (Men√∫ Superior Fijo) */
      .sidebar {
        width: 100%;
        height: auto;
        padding: 15px 10px;
        position: sticky;
        top: 0;
        z-index: 1000;
        flex-direction: row; /* Elementos del sidebar en fila */
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .profile-pic, .sidebar h4, .sidebar .small-muted {
          display: none; /* Oculta elementos grandes en m√≥vil */
      }
      .sidebar-menu {
          display: flex; /* Muestra el men√∫ en fila */
          width: auto;
          margin: 0;
          overflow-x: auto; /* Permite scroll horizontal si hay muchos botones */
          padding-bottom: 5px;
      }
      .sidebar-menu li {
          flex-shrink: 0;
          margin-right: 5px;
      }
      .sidebar-menu button {
          padding: 8px 12px;
          font-size: 0.8rem;
          white-space: nowrap;
          font-weight: 500;
      }
      .sidebar-menu button i {
          margin-right: 5px;
      }
      #logout-btn {
          margin-left: 10px;
          padding: 8px 12px;
          font-size: 0.8rem;
          font-weight: 700;
      }
      
      /* Header del Panel */
      .header-panel {
          margin-bottom: 1rem;
          flex-direction: column;
          align-items: flex-start;
          padding-bottom: 0.5rem;
      }
      .header-panel h2 {
          font-size: 1.8rem;
      }
      
      /* Contenido de Tabs (Para que no se vea tan denso) */
      .tab-content {
          padding: 20px;
      }
      .section-header h3 {
          font-size: 1.5rem;
      }

      /* Sidebar de Reservas Apilado */
      .sidebar-reservas {
          min-width: 100%;
          max-height: 300px; /* Limita la altura para no ocupar toda la pantalla */
          order: -1; /* Mueve la lista de reservas al inicio de la columna */
      }
      
      /* Calendario Ajustes */
      .calendar-wrapper {
          padding: 8px;
      }
      .calendar-table {
          min-width: 500px; /* Asegura que el calendario tenga espacio para el scroll horizontal */
      }
      .time-col {
          width: 60px; /* Reduce ancho de columna de hora */
          font-size: 0.75rem;
          padding-left: 8px;
      }
      .calendar-table thead th {
          font-size: 0.75rem;
          padding: 8px 4px;
      }
      .calendar-table td {
          height: 40px;
          padding: 4px;
      }
      .week-controls {
          gap: 5px;
          font-size: 0.9rem;
      }
      .week-controls button {
          padding: 6px 8px;
      }
      .week-label {
          font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="profile-pic">
      <img id="sidebar-avatar" src="francisca-avatar.jpg" alt="avatar" onerror="this.src='https://via.placeholder.com/150'"/>
    </div>
    <h4 id="sidebar-name">Cargando...</h4>
    <div class="sidebar small-muted" id="sidebar-sub">Cargando...</div>

    <ul class="sidebar-menu">
      <li><button class="menu-btn active" data-tab="agenda-tab"><i class="fas fa-calendar-alt"></i> Agenda</button></li>
      <li><button class="menu-btn" data-tab="evoluciones-tab"><i class="fas fa-notes-medical"></i> Evoluciones</button></li>
      <li><button class="menu-btn" data-tab="atenciones-completadas-tab"><i class="fas fa-history"></i> Historial</button></li> 
      <li><button class="menu-btn" data-tab="datos-tab"><i class="fas fa-user-circle"></i> Mis datos</button></li>
      </ul>
    <button class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>
  </div>

  <div class="main-content">
    
    <div class="agenda-area">

        <div class="header-panel">
            <h2 id="welcome-message">Cargando perfil</h2>
            <div id="header-actions"></div>
        </div>

        <div id="agenda-tab" class="tab-content active">
          <div class="section-header">
            <h3>Gesti√≥n de Agenda</h3>
            <p>Selecciona los d√≠as y horarios para generar tu agenda semanal. Haz click sobre un slot disponible (<span style="color:var(--accent);font-weight:700">Naranja</span>) para eliminarlo.</p>
          </div>

          <div class="section-header">
            <h3>Mi Agenda Semanal</h3>
            <div id="agenda-status" class="info-msg"> <span class="spinner"></span> Cargando semana...</div>
          </div>

          <div class="week-controls">
            <div style="display:flex;gap:8px;align-items:center">
              <button id="prev-week" class="logout-btn" style="background:#fff;color:var(--primary);border:1px solid #e9ecef;padding:8px 12px;">
                <i class="fas fa-chevron-left"></i> Anterior
              </button>
              <button id="next-week" class="logout-btn" style="background:#fff;color:var(--primary);border:1px solid #e9ecef;padding:8px 12px;">
                Siguiente <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <div style="display:flex;align-items:center;gap:18px">
              <div class="week-label" id="week-label">Cargando semana...</div>
            </div>
          </div>

          <div id="agenda-error" style="display:none" class="error-box"></div>

          <div class="calendar-wrapper" id="calendar-wrap" style="display:none">
            <table class="calendar-table" aria-label="Calendario semanal">
              <thead>
                <tr id="calendar-head">
                  <th class="time-col">Hora</th>
                </tr>
              </thead>
              <tbody id="calendar-body"></tbody>
            </table>
          </div>

        </div>

        <div id="evoluciones-tab" class="tab-content">
            <div class="section-header">
                <h3>Evoluciones Pendientes y Registro</h3>
                <p>Aqu√≠ se listan las citas reservadas. Selecciona una para registrar la evoluci√≥n.</p>
            </div>
            
            <div id="evoluciones-main-view">
                <h4>Citas Pendientes de Evoluci√≥n</h4>
                <div id="pendingAppointmentsList">
                    <p><span class="spinner"></span> Cargando citas pendientes...</p>
                </div>
            </div>
            
            <div id="evolution-form-container" class="tab-content" style="display: none; padding: 0;">
                <h4 style="color: var(--primary);">Registrar Evoluci√≥n</h4>
                <div class="hint-box" style="margin-bottom: 20px;">
                    <p><strong>Paciente:</strong> <span id="evol_patient_name"></span> (<span id="evol_patient_rut"></span>)</p>
                    <p><strong>Hora:</strong> <span id="evol_appointment_time"></span></p>
                    <p><strong>Motivo Inicial:</strong> <span id="evol_patient_motivo"></span></p>
                </div>
                
                <form id="saveEvolutionForm">
                    <input type="hidden" id="evol_agenda_id">
                    <input type="hidden" id="evol_patient_rut_hidden">
                    <input type="hidden" id="evol_patient_nombre_hidden">
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="diagnostico">Diagn√≥stico (Opcional)</label>
                        <input type="text" id="diagnostico" placeholder="C√≥digo CIE-10 o descripci√≥n breve">
                    </div>
                    
                    <div class="form-group">
                        <label for="evol_description">Descripci√≥n de la Atenci√≥n y Evoluci√≥n</label>
                        <textarea id="evol_description" rows="10" required placeholder="Diagn√≥stico, tratamiento realizado, observaciones y plan de seguimiento..."></textarea>
                    </div>
                    <button type="submit" class="logout-btn" style="background:var(--success); width: 100%; margin-top: 15px;">Confirmar Atenci√≥n y Guardar Evoluci√≥n</button>
                    <button type="button" id="cancelEvolutionBtn" class="logout-btn" style="background:var(--muted); width: 100%; margin-top: 10px;">Cancelar / Volver</button>
                </form>
            </div>
        </div>
        <div id="atenciones-completadas-tab" class="tab-content">
            <div class="section-header">
                <h3>Historial Cl√≠nico y Evoluciones Completadas</h3>
                <p>Revisa el historial de atenciones. La lista muestra todas las evoluciones del √∫ltimo a√±o.</p>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <input type="text" id="historyFilterInput" placeholder="Filtrar por Nombre, RUT o Fecha (Ej: 2025-10)" style="padding: 10px; width: 80%; max-width: 400px; border: 1px solid #ddd; border-radius: 6px;">
                <div id="historyStatus" style="margin-top: 10px; color: var(--muted);"></div>
            </div>
            
            <div id="completedEvolutionsList">
                <p>Cargando historial...</p>
            </div>
        </div>
        <div id="datos-tab" class="tab-content">
          <h3>Mis Datos</h3>
          <p>Aqu√≠ ir√° el formulario para editar datos personales.</p>
        </div>

        <div id="perfil-tab" class="tab-content">
          <h3>Mi Perfil</h3>
          <p>Aqu√≠ podr√°s editar tu biograf√≠a y servicios.</p>
        </div>

    </div> 
    <div class="sidebar-reservas">
        <h3>Reservas de la Semana</h3>
        <p id="reserva-dia-actual" style="font-weight: bold; color: var(--accent);">Selecciona un d√≠a en la agenda</p>
        <div id="reserva-list-container">
            <div class="hint-box">Haz click en los encabezados de los d√≠as (Lun, Mar, etc.) para ver la lista de citas de ese d√≠a y sus detalles.</div>
        </div>
    </div>
    </div>
  <script>
  /****************** Supabase setup - CREDENCIALES CORREGIDAS ******************/
  // Tomadas de panel-10.html
  const supabaseUrl = 'https://sncznbowdiarakoekxit.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuY3puYm93ZGlhcmFrb2VreGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTcwMTgsImV4cCI6MjA3NTkzMzAxOH0.X7hSM3_h0kPPpbxm-y7pbtOPXpnmk41uiwrN4lnGRJU';
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

  /****************** DOM refs ******************/
  const welcomeMessage = document.getElementById('welcome-message');
  const sidebarNameEl = document.getElementById('sidebar-name');
  const sidebarSubEl = document.getElementById('sidebar-sub');
  const calendarHead = document.getElementById('calendar-head');
  const calendarBody = document.getElementById('calendar-body');
  const weekLabel = document.getElementById('week-label');
  const prevWeekBtn = document.getElementById('prev-week');
  const nextWeekBtn = document.getElementById('next-week');
  const agendaStatus = document.getElementById('agenda-status');
  const agendaErrorBox = document.getElementById('agenda-error');
  const calendarWrap = document.getElementById('calendar-wrap');
  const logoutBtn = document.getElementById('logout-btn');
  const reservaDiaActualEl = document.getElementById('reserva-dia-actual');
  const reservaListContainerEl = document.getElementById('reserva-list-container');
  // Refs para Evoluciones
  const pendingAppointmentsListEl = document.getElementById('pendingAppointmentsList');
  const evolutionFormContainerEl = document.getElementById('evolution-form-container');
  const saveEvolutionFormEl = document.getElementById('saveEvolutionForm');
  const cancelEvolutionBtnEl = document.getElementById('cancelEvolutionBtn');
  const evolMainViewEl = document.getElementById('evoluciones-main-view');
  // Refs para Historial
  const completedEvolutionsListEl = document.getElementById('completedEvolutionsList');
  const historyFilterInputEl = document.getElementById('historyFilterInput');
  const historyStatusEl = document.getElementById('historyStatus');


  /****************** Estado ******************/
  let currentProfessionalId = null;
  // CAMBIO CLAVE: Ajuste a 60 minutos para slots de hora en hora
  const startHour = 8, endHour = 21, slotIntervalMin = 60; 
  let timeSlots = [];
  let startOfWeekDate = getStartOfWeek(new Date());
  let agendaMap = new Map(); 
  let currentReservas = []; 
  let selectedReservaDate = null; 
  let allCompletedEvolutions = []; // Nueva lista para almacenar el historial completo

  /****************** Utilidades de fecha ******************/
  function pad(n){ return String(n).padStart(2,'0'); }
  function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function formatDayName(dateStr) {
      const d = new Date(dateStr + 'T12:00:00'); 
      return d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
  }
  function getStartOfWeek(date){
    const d = new Date(date);
    const day = d.getDay(); 
    const diff = (day === 0 ? -6 : 1) - day; 
    d.setDate(d.getDate() + diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // Funci√≥n para calcular la edad (usada en el Panel, no en el formulario de reserva)
  function calculateAge(dateString) {
      if (!dateString) return 'N/D';
      const today = new Date();
      const birthDate = new Date(dateString);
      let age = today.getFullYear() - birthDate.getFullYear();
      const monthDiff = today.getMonth() - birthDate.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
      }
      return age >= 0 ? `${age} a√±os` : 'N/D';
  }

  /****************** Generar slots (sincr√≥nico) ******************/
  function generateTimeSlots(){
    timeSlots = [];
    const temp = new Date();
    temp.setHours(startHour,0,0,0);
    while (temp.getHours() < endHour || (temp.getHours() === endHour && temp.getMinutes() === 0)) {
      const t = `${pad(temp.getHours())}:${pad(temp.getMinutes())}`;
      timeSlots.push(t);
      // Utiliza la variable slotIntervalMin
      temp.setMinutes(temp.getMinutes() + slotIntervalMin); 
    }
  }

  /****************** L√ìGICA DE EVOLUCIONES Y HISTORIAL ******************/
  
  // 1. Renderizar la lista de citas pendientes (slots reservados)
  function renderPendingAppointments() {
      pendingAppointmentsListEl.innerHTML = '';
      
      const todayDateStr = toISODate(new Date());
      
      // üõë CLAVE: Filtramos por slots reservados (disponible: false) Y que no tengan evolucion_registrada: TRUE
      const appointments = currentReservas.filter(r => r.disponible === false && r.evolucion_registrada !== true).sort((a, b) => {
          return (a.fecha + a.hora_inicio).localeCompare(b.fecha + b.hora_inicio);
      });
      
      if (appointments.length === 0) {
          pendingAppointmentsListEl.innerHTML = '<p>üéâ No hay citas reservadas pendientes de evoluci√≥n.</p>';
          return;
      }
      
      const ul = document.createElement('ul');
      ul.classList.add('reserva-list');
      
      appointments.forEach(cita => {
          const li = document.createElement('li');
          li.classList.add('pending-item');
          li.id = `pending-item-${cita.id}`; 
          
          const hora = cita.hora_inicio.substring(0, 5);
          const nombre = cita.paciente_nombre || 'Paciente Desconocido';
          const isPast = cita.fecha < todayDateStr;
          const statusColor = isPast ? 'var(--danger)' : 'var(--success)';

          li.innerHTML = `
              <div class="pending-item-info">
                  <span class="reserva-time" style="color: ${statusColor};"><i class="fas fa-calendar-day"></i> ${cita.fecha} - ${hora} (${isPast ? 'PASADA' : 'PR√ìXIMA'})</span>
                  <div class="reserva-details">
                      Paciente: <strong>${nombre}</strong> (RUT: ${cita.paciente_rut || 'N/A'})
                  </div>
              </div>
              <button data-agenda-id="${cita.id}" class="register-evol-btn">Registrar Evoluci√≥n</button>
          `;
          
          ul.appendChild(li);
      });
      
      pendingAppointmentsListEl.appendChild(ul);
      
      document.querySelectorAll('.register-evol-btn').forEach(button => {
          button.addEventListener('click', (e) => {
              const agendaId = e.target.dataset.agendaId;
              const cita = currentReservas.find(r => r.id === agendaId);
              if (cita) showEvolutionForm(cita);
          });
      });
  }

  // 2. Mostrar el formulario de evoluci√≥n con datos precargados
  function showEvolutionForm(cita) {
      evolMainViewEl.style.display = 'none';
      evolutionFormContainerEl.style.display = 'block';
      
      // Precargar datos del paciente
      document.getElementById('evol_patient_name').textContent = cita.paciente_nombre || 'N/A';
      document.getElementById('evol_patient_rut').textContent = cita.paciente_rut || 'N/A';
      document.getElementById('evol_appointment_time').textContent = `${cita.fecha} a las ${cita.hora_inicio.substring(0, 5)}`;
      document.getElementById('evol_patient_motivo').textContent = cita.comentarios || 'Sin motivo inicial';
      
      // Campos ocultos para el guardado
      document.getElementById('evol_agenda_id').value = cita.id;
      document.getElementById('evol_patient_rut_hidden').value = cita.paciente_rut || '';
      document.getElementById('evol_patient_nombre_hidden').value = cita.paciente_nombre || '';
      
      // Limpiar formulario al abrir
      document.getElementById('evol_description').value = ''; 
      document.getElementById('diagnostico').value = ''; 
  }

  // 3. Volver a la lista
  cancelEvolutionBtnEl.addEventListener('click', () => {
      evolutionFormContainerEl.style.display = 'none';
      evolMainViewEl.style.display = 'block';
  });

  // 4. Guardar la evoluci√≥n
  saveEvolutionFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const agendaId = document.getElementById('evol_agenda_id').value;
      const pacienteRut = document.getElementById('evol_patient_rut_hidden').value;
      const pacienteNombre = document.getElementById('evol_patient_nombre_hidden').value;
      const contenidoEvol = document.getElementById('evol_description').value.trim();
      const diagnostico = document.getElementById('diagnostico').value.trim(); 
      
      const cita = currentReservas.find(r => r.id === agendaId);
      const fechaAtencion = cita ? cita.fecha : toISODate(new Date());

      if (!contenidoEvol || !pacienteRut || !currentProfessionalId) {
          alert('Error: Faltan datos esenciales (evoluci√≥n, RUT o ID de profesional). No se puede guardar.');
          return;
      }
      
      const pendingItemEl = document.getElementById(`pending-item-${agendaId}`);
      
      // 1. Aplicar efecto de desaparici√≥n al elemento de la lista (Visual)
      if (pendingItemEl) {
          pendingItemEl.classList.add('fade-out');
      }

      // 2. Guardar la evoluci√≥n en la tabla `evoluciones`
      const { data: evolData, error: evolError } = await supabaseClient
          .from('evoluciones')
          .insert([{
              profesional_id: currentProfessionalId, 
              paciente_rut: pacienteRut,
              paciente_nombre: pacienteNombre, 
              fecha_atencion: fechaAtencion, 
              descripcion_evol: contenidoEvol,
              diagnostico_cie: diagnostico, 
              estado: 'Completada',
          }])
          .select()
          .single();

      if (evolError) {
          console.error('Error al guardar la evoluci√≥n:', evolError);
          alert('Ocurri√≥ un error al guardar la evoluci√≥n. Revisa la consola (F12).');
          if (pendingItemEl) pendingItemEl.classList.remove('fade-out'); 
          return;
      }

      // 3. üõë CLAVE: Marcar la cita como evolucionada en la tabla 'agendas'
      const { error: updateError } = await supabaseClient
          .from('agendas')
          .update({ evolucion_registrada: true })
          .eq('id', agendaId);
          
      if (updateError) {
          console.error('Error al actualizar la agenda como evolucionada:', updateError);
          alert('Evoluci√≥n guardada, pero hubo un error al marcar la cita como completada. Recarga la p√°gina.');
      }
      
      alert(`Evoluci√≥n para ${pacienteNombre} guardada con √©xito.`);
      
      // 4. Recargar el flujo de la UI
      setTimeout(async () => {
          evolutionFormContainerEl.style.display = 'none';
          evolMainViewEl.style.display = 'block';
          await loadWeekSchedule(); 
          await loadCompletedEvolutions(); // Recargar el historial
          renderPendingAppointments();
      }, 300); 
  });

  // 5. L√ìGICA DE CARGA Y FILTRO DE HISTORIAL COMPLETO
  async function loadCompletedEvolutions() {
      historyStatusEl.innerHTML = '<span class="spinner"></span> Cargando historial...';
      
      // 1. Traer todas las evoluciones del profesional
      const { data, error } = await supabaseClient
          .from('evoluciones')
          .select('*')
          .eq('profesional_id', currentProfessionalId)
          .order('fecha_atencion', { ascending: false });

      if (error) {
          console.error('Error al cargar historial completo:', error);
          historyStatusEl.textContent = 'Error al cargar el historial.';
          allCompletedEvolutions = [];
          return;
      }

      allCompletedEvolutions = data || [];
      renderHistoryCards(allCompletedEvolutions);
  }
  
  // 6. Renderizar las tarjetas de historial y agrupar por paciente
  function renderHistoryCards(evolutions) {
      completedEvolutionsListEl.innerHTML = '';
      
      if (evolutions.length === 0) {
          completedEvolutionsListEl.innerHTML = '<p>No se encontraron evoluciones que coincidan con el filtro.</p>';
          historyStatusEl.textContent = 'Historial cargado: 0 resultados.';
          return;
      }

      // Agrupar evoluciones por RUT del paciente
      const groupedEvolutions = evolutions.reduce((acc, evol) => {
          const rut = evol.paciente_rut;
          if (!acc[rut]) {
              acc[rut] = {
                  nombre: evol.paciente_nombre,
                  rut: rut,
                  citas: []
              };
          }
          acc[rut].citas.push(evol);
          return acc;
      }, {});

      historyStatusEl.textContent = `Historial cargado: ${evolutions.length} atenciones. (${Object.keys(groupedEvolutions).length} pacientes)`;
      
      Object.values(groupedEvolutions).forEach(patientData => {
          const patientCard = document.createElement('div');
          patientCard.classList.add('patient-card-summary');
          const collapseId = `evol-list-${patientData.rut.replace(/[^a-zA-Z0-9]/g, '')}`; // Crea un ID seguro

          patientCard.innerHTML = `
              <div>
                  <h4><i class="fas fa-user-check"></i> ${patientData.nombre || 'Paciente Sin Nombre'}</h4>
                  <p style="color: #eee; margin: 0;">RUT: ${patientData.rut}</p>
              </div>
              <i class="fas fa-chevron-down"></i>
          `;
          
          const historyContainer = document.createElement('div');
          historyContainer.classList.add('evolutions-detail-list');
          historyContainer.id = collapseId;

          patientData.citas.forEach(evol => {
              const card = document.createElement('div');
              card.classList.add('history-card');
              card.innerHTML = `
                  <h5><i class="fas fa-calendar-check"></i> Atenci√≥n del ${new Date(evol.fecha_atencion).toLocaleDateString('es-ES')}</h5>
                  <p>Diagn√≥stico: ${evol.diagnostico_cie || 'N/D'}</p>
                  <div class="history-content">
                      ${evol.descripcion_evol}
                  </div>
              `;
              historyContainer.appendChild(card);
          });

          // Toggle logic (abrir/cerrar historial)
          patientCard.addEventListener('click', () => {
              historyContainer.classList.toggle('active');
              const icon = patientCard.querySelector('.fas');
              if (historyContainer.classList.contains('active')) {
                  icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
              } else {
                  icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
              }
          });
          
          completedEvolutionsListEl.appendChild(patientCard);
          completedEvolutionsListEl.appendChild(historyContainer);
      });
  }

  // 7. Evento de filtro din√°mico
  historyFilterInputEl.addEventListener('input', (e) => {
      const filterTerm = e.target.value.toLowerCase().trim();
      
      if (!allCompletedEvolutions.length) {
          renderHistoryCards([]);
          return;
      }
      
      const filtered = allCompletedEvolutions.filter(evol => {
          const nameMatch = (evol.paciente_nombre || '').toLowerCase().includes(filterTerm);
          const rutMatch = (evol.paciente_rut || '').toLowerCase().includes(filterTerm);
          const dateMatch = (evol.fecha_atencion || '').includes(filterTerm);

          return nameMatch || rutMatch || dateMatch;
      });
      
      renderHistoryCards(filtered);
  });


  /****************** Render del calendario (Vista Agenda) ******************/
  async function renderCalendar(){
    // Limpiar y crear encabezados d√≠as
    calendarHead.querySelectorAll('th:not(.time-col)').forEach(n=>n.remove());
    const dayNames = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
    for (let i=0;i<7;i++){
      const d = addDays(startOfWeekDate,i);
      const th = document.createElement('th');
      const dateStr = toISODate(d);
      th.dataset.date = dateStr;
      
      // Listener para cargar reservas del d√≠a en el panel lateral
      th.addEventListener('click', () => {
          selectedReservaDate = dateStr;
          calendarHead.querySelectorAll('th').forEach(t => t.classList.remove('active-day-head'));
          th.classList.add('active-day-head');
          renderReservasSidebar(dateStr);
      });
      
      th.innerHTML = `<div style="font-weight:700">${dayNames[i]}</div><div style="font-size:.85rem;color:var(--muted)">${toISODate(d).substring(5)}</div>`;
      calendarHead.appendChild(th);
    }

    // Filas por horario
    calendarBody.innerHTML = '';
    for (const time of timeSlots) {
      const tr = document.createElement('tr');
      const tdTime = document.createElement('td');
      tdTime.className = 'time-col';
      tdTime.textContent = time;
      tr.appendChild(tdTime);

      for (let i=0;i<7;i++){
        const d = addDays(startOfWeekDate,i);
        const dateStr = toISODate(d);
        const key = `${dateStr}|${time}`;

        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'cell available';
        cell.dataset.date = dateStr;
        cell.dataset.time = time;
        cell.dataset.key = key;
        cell.title = `${dateStr} ${time}`;
        cell.innerHTML = ``; 

        const record = agendaMap.get(key);
        if (record) {
          if (record.disponible === false) {
            // SLOTS RESERVADOS (booked)
            const nombrePaciente = record.paciente_nombre || 'Paciente Desconocido'; 
            const rutPaciente = record.paciente_rut || 'Sin RUT';
            const prevision = record.paciente_prevision || 'N/D';
            const edad = calculateAge(record.paciente_fecha_nac);
            
            cell.className = 'cell booked booked-cell';
            // Title con todos los datos
            cell.title = `RESERVADO:\nPaciente: ${nombrePaciente}\nRUT: ${rutPaciente}\nEdad: ${edad}\nPrevisi√≥n: ${prevision.toUpperCase()}\nMotivo: ${record.comentarios || 'N/D'}`;
            cell.innerHTML = `<i class="fas fa-user-tag" style="margin-right:5px"></i> ${time}`;
            cell.style.backgroundColor = 'var(--success)'; 
            cell.style.color = '#fff';

          } else {
            // SLOTS DISPONIBLES (active)
            cell.className = 'cell active';
            cell.title = `Disponible - ${dateStr} ${time}`;
            cell.style.backgroundColor = 'var(--accent)';
            cell.innerHTML = `<i class="fas fa-check"></i> ${time}`;
          }
        } else {
          // SLOTS NO AGENDADOS (available)
          cell.className = 'cell available';
          cell.title = `${dateStr} ${time}`;
          cell.innerHTML = ``;
        }

        cell.addEventListener('click', async (ev) => {
          if (cell.classList.contains('booked-cell')) return; 
          await toggleCellAvailability(cell);
        });

        td.appendChild(cell);
        tr.appendChild(td);
      }

      calendarBody.appendChild(tr);
    }

    weekLabel.textContent = `${toISODate(startOfWeekDate)} ‚Äî ${toISODate(addDays(startOfWeekDate,6))}`;
    
    renderReservasSidebar(selectedReservaDate); 
  }
  
  /****************** RENDERIZADO DEL PANEL LATERAL ******************/
  function renderReservasSidebar(dateStr = null) {
      let reservasToShow;
      
      if (dateStr) {
          reservasToShow = currentReservas.filter(r => r.fecha === dateStr);
          reservaDiaActualEl.textContent = `Reservas para el ${formatDayName(dateStr)}`;
      } else {
          reservasToShow = currentReservas;
          reservaDiaActualEl.textContent = 'Reservas de la Semana (Total)';
      }

      reservaListContainerEl.innerHTML = '';
      
      if (reservasToShow.length === 0) {
          reservaListContainerEl.innerHTML = `<p>No hay reservas ${dateStr ? 'para este d√≠a' : 'en esta semana'}.</p>`;
          if (!dateStr) {
              reservaListContainerEl.innerHTML = '<div class="hint-box">Haz click en los encabezados de los d√≠as (Lun, Mar, etc.) para ver la lista de citas de ese d√≠a y sus detalles.</div>';
          }
          return;
      }
      
      const ul = document.createElement('ul');
      ul.classList.add('reserva-list');

      reservasToShow.forEach(reserva => {
          const nombrePaciente = reserva.paciente_nombre || 'Desconocido';
          const rutPaciente = reserva.paciente_rut || 'N/A';
          const hora = String(reserva.hora_inicio).substring(0, 5);
          const motivo = reserva.comentarios || 'Sin especificar'; 
          const prevision = reserva.paciente_prevision ? reserva.paciente_prevision.toUpperCase() : 'N/D';
          const edad = calculateAge(reserva.paciente_fecha_nac);
          const fecha = reserva.fecha;
          
          const li = document.createElement('li');
          li.classList.add('reserva-item');

          li.innerHTML = `
              <span class="reserva-time"><i class="fas fa-clock"></i> ${hora} ${dateStr ? '' : `(${fecha.substring(5)})`}</span>
              <div class="reserva-details">
                  Paciente: <strong>${nombrePaciente}</strong> (Edad: ${edad})<br>
                  RUT: ${rutPaciente}<br>
                  Previsi√≥n: ${prevision}<br>
                  Motivo: <em>${motivo}</em>
              </div>
          `;
          
          li.addEventListener('click', () => {
              alert(`Detalles de la Cita:\n
              Hora: ${hora}\nD√≠a: ${fecha}\n
              Paciente: ${nombrePaciente}\nRUT: ${rutPaciente}\n
              Edad: ${edad}\nPrevisi√≥n: ${prevision}\n
              Motivo de Consulta: ${motivo}`);
          });
          
          ul.appendChild(li);
      });
      
      reservaListContainerEl.appendChild(ul);
  }

  /****************** Cargar agenda semana desde Supabase ******************/
  async function loadWeekSchedule(){
    agendaErrorBox.style.display = 'none';
    agendaStatus.innerHTML = '<span class="spinner"></span> Cargando semana...';
    calendarWrap.style.display = 'none';
    try {
      if (!currentProfessionalId) throw new Error('professional id undefined');

      const start = toISODate(startOfWeekDate);
      const end = toISODate(addDays(startOfWeekDate,6));

      // üõë SELECT FINAL: Incluye todos los campos de paciente.
      const { data, error } = await supabaseClient
        .from('agendas')
        .select('id, profesional_id, fecha, hora_inicio, disponible, paciente_nombre, paciente_rut, paciente_fecha_nac, paciente_prevision, comentarios, evolucion_registrada') 
        .eq('profesional_id', currentProfessionalId)
        .gte('fecha', start)
        .lte('fecha', end)
        .order('fecha', {ascending:true});

      if (error) {
        console.error('Error al traer agendas (Supabase error object):', error);
        throw error;
      }

      agendaMap.clear();
      currentReservas = []; 
      
      (data || []).forEach(item => {
        const horaRaw = item.hora_inicio || item.hora_fin || null;
        if (!horaRaw) return;
        
        const hora = String(horaRaw).substring(0,5); 
        const key = `${item.fecha}|${hora}`;
        agendaMap.set(key, item);
        
        if (item.disponible === false) {
             currentReservas.push(item); 
        }
      });

      renderCalendar();
      renderPendingAppointments(); // üõë Actualizar la lista de pendientes
      calendarWrap.style.display = 'block';
      agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--muted)">Agenda cargada</span>';
    } catch (err) {
      console.error('loadWeekSchedule error:', err);
      agendaErrorBox.style.display = 'block';
      agendaErrorBox.textContent = 'No se pudo cargar la agenda de la semana. Revisa la consola (F12) para m√°s detalles.';
      agendaStatus.innerHTML = '<span style="color:#7a1f1f">Error al cargar semana</span>';
    }
  }

  /****************** Toggle disponibilidad (crear o ELIMINAR) ******************/
  async function toggleCellAvailability(cell){
    cell.classList.add('saving'); 
    const date = cell.dataset.date;
    const time = cell.dataset.time;
    const key = cell.dataset.key;
    try {
      const existing = agendaMap.get(key);

      if (existing) {
        if (existing.disponible === true) {
             // L√ìGICA DE ELIMINACI√ìN
            const { error: deleteError } = await supabaseClient
                .from('agendas')
                .delete()
                .eq('id', existing.id);

            if (deleteError) throw deleteError;
        } else {
             console.warn('Acci√≥n bloqueada: Slot reservado.', key);
             return; 
        }

        await loadWeekSchedule(); 
        
      } else {
        // Slot no existe, lo creamos (disponible)
        const { data, error } = await supabaseClient
          .from('agendas')
          .insert([{
            profesional_id: currentProfessionalId,
            fecha: date,
            hora_inicio: time + ':00', 
            disponible: true
          }])
          .select()
          .single();

        if (error) throw error;
        data.hora_inicio = time;
        agendaMap.set(key, data);
        
        await loadWeekSchedule(); 
      }
    } catch (err) {
      console.error('Error guardando/eliminando disponibilidad:', err);
      alert('Ocurri√≥ un error al guardar/eliminar la disponibilidad. Revisa la consola.');
    } finally {
      cell.classList.remove('saving');
    }
  }

  /****************** Navegaci√≥n semanas ******************/
  prevWeekBtn.addEventListener('click', async () => {
    startOfWeekDate = addDays(startOfWeekDate, -7);
    await loadWeekSchedule();
  });
  nextWeekBtn.addEventListener('click', async () => {
    startOfWeekDate = addDays(startOfWeekDate, 7);
    await loadWeekSchedule();
  });

  /****************** Auth y carga inicial ******************/
  async function checkAuth(){
    try {
      agendaStatus.innerHTML = '<span class="spinner"></span> Verificando sesi√≥n...';
      const resp = await supabaseClient.auth.getUser();
      const user = resp?.data?.user ?? null;
      
      if (!user) {
        window.location.href = 'portal.html';
        return;
      }

      const { data: prof, error: profError } = await supabaseClient
          .from('profesionales')
          .select('id,nombre,email')
          .eq('email', user.email)
          .maybeSingle(); 

      if (profError || !prof) {
        welcomeMessage.textContent = 'Error cargando perfil';
        sidebarNameEl.textContent = 'Usuario';
        sidebarSubEl.textContent = `Error: Perfil no encontrado para ${user.email}`;
        agendaStatus.innerHTML = '<span style="color:#7a1f1f">Necesita configuraci√≥n</span>';
        
        await supabaseClient.auth.signOut();
        window.location.href = 'portal.html';
        return;
      }

      currentProfessionalId = prof.id;
      welcomeMessage.textContent = `¬°Hola, ${prof.nombre}!`;
      sidebarNameEl.textContent = prof.nombre;
      sidebarSubEl.textContent = prof.email || '';

      generateTimeSlots();
      
      setTimeout(async () => {
          await loadWeekSchedule();
          await loadCompletedEvolutions(); // üõë Cargar historial al inicio
          agendaStatus.innerHTML = '<span style="font-weight:700;color:var(--muted)">Listo</span>';
      }, 50); 

    } catch (err) {
      console.error('checkAuth error (fatal):', err);
      await supabaseClient.auth.signOut();
      window.location.href = 'portal.html';
    }
  }

  /****************** Logout ******************/
  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'portal.html';
  });

  /****************** Tabs UI ******************/
  document.querySelectorAll('.menu-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      if (tab) document.getElementById(tab).classList.add('active');
    });
  });

  /****************** Inicializar ******************/
  document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
  });

</script>
</body>
</html>
