<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Francisca Sandoval | Psicofit - Bienestar Psicológico de Último Nivel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* PALETA DE COLORES - Profesional y Minimalista */
        :root {
            --primary: #2C3A47; /* Gris Azulado Oscuro */
            --accent: #B8860B; /* Ocre Suave/Bronce (Acción/Énfasis) */
            --bg: #F9F7F1; /* Blanco Roto Cálido */
            --bg-light: #FFFFFF; /* Blanco Puro para Headers */
            --muted: #A3A3A3; /* Gris Suave */
            --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.05);
            --success: #1e7e34;
            --danger: #d9534f;
        }

        /* Estilos Base y Tipografía */
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            line-height: 1.8;
            color: #495057;
            background-color: var(--bg);
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
        }

        /* Header (Se mantiene fijo) */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-light);
            box-shadow: var(--shadow-subtle);
            z-index: 1000;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Playfair Display', serif;
            text-decoration: none;
        }

        .header-actions a, .header-actions button {
            text-decoration: none;
            color: var(--primary);
            font-weight: 500;
            margin-left: 20px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
            border: 1px solid transparent;
            background: none;
            cursor: pointer;
        }

        .header-actions a:hover, .header-actions button:hover {
            background-color: var(--bg);
            border-color: #ddd;
        }

        .header-actions .btn-accent {
            background-color: var(--accent);
            color: white;
            border: 1px solid var(--accent);
        }

        .header-actions .btn-accent:hover {
            background-color: #a07a0a;
            border-color: #a07a0a;
        }

        /* Sección Hero / Banner */
        .hero {
            padding-top: 90px; /* Espacio para el header fijo */
            min-height: 60vh;
            background: linear-gradient(rgba(44, 58, 71, 0.8), rgba(44, 58, 71, 0.8)), url('hero-psicologia.jpg') no-repeat center center/cover;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-bottom: 50px;
        }

        .hero-content {
            max-width: 800px;
            padding: 30px;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: white;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.2rem;
            font-weight: 300;
            margin-bottom: 30px;
        }

        .btn-main {
            background-color: var(--accent);
            color: white;
            padding: 12px 30px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 700;
            transition: opacity 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-main:hover {
            opacity: 0.9;
        }

        /* Contenido Principal / Formulario */
        main {
            padding: 0 5% 50px;
        }

        .process-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .step-indicator {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid var(--muted);
            border-radius: 50px;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .step-indicator.active {
            background-color: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .step-content {
            background-color: var(--bg-light);
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow-subtle);
            min-height: 400px;
            margin-top: 20px;
        }

        /* Estilos del Formulario */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--primary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        
        /* Botones de Navegación del Formulario */
        .form-nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .btn-secondary {
            background-color: #f1f1f1;
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 700;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        /* Contenido de Servicios */
        #service-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .service-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 5px solid transparent;
        }
        
        .service-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .service-card.selected {
            border-left: 5px solid var(--accent);
            background-color: #fffaf0;
        }
        
        .service-card h4 {
            margin-top: 0;
            color: var(--accent);
            font-size: 1.3rem;
        }

        /* --- CALENDARIO DE TABLA (VISTA SEMANAL) - COPIADO DE PANEL-7.HTML --- */
        .calendar-table{border-collapse:collapse;width:100%;min-width:700px; margin-top: 20px; font-size: 0.9rem;} 
        .calendar-table thead th{
            position:sticky;top:0;
            background:var(--primary);
            color:white;
            border-bottom:1px solid #e9ecef;
            padding:10px 8px;
            text-align:center;
            font-weight:700;
            cursor:pointer; 
            width: 10%;
        } 
        .time-col{
            width:80px;
            text-align:center;
            padding:10px 5px;
            background:var(--bg);
            font-weight:700;
            color:var(--primary);
            border-right:1px solid #e9ecef
        } 
        .calendar-table td{height:45px;padding:3px; border: 1px solid #eee; background-color: white; text-align: center;}
        .cell{
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:4px;
            cursor:pointer;
            user-select:none;
            transition:background .2s, border-color .2s;
            font-weight:500;
            height:100%;
            width:100%;
            font-size: 0.85rem;
            color: var(--primary);
        }
        .cell.available{
            background: var(--accent);
            border:1px solid var(--accent);
            color: white;
            font-weight: 700;
        }
        .cell.available:hover{background:#a07a0a; color:#fff;}
        .cell.not-available{background:#eee;color:#999;cursor:not-allowed;} 

        .calendar-wrapper { overflow-x: auto; border-radius: 10px; border: 1px solid #e9ecef; background: #fff; padding: 10px; }
        .week-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px}
        .week-label{font-weight:700;color:var(--primary);font-size:1.05rem}

        .btn-nav{background:#fff;color:var(--primary);border:1px solid #e9ecef;padding:8px 12px;cursor:pointer;font-weight:700;border-radius: 6px; transition: background-color 0.2s;}
        .btn-nav:hover{background-color: #eee;}
        
        /* Estado de Carga y Mensajes */
        #status-message {
            text-align: center;
            margin-top: 20px;
            font-weight: 700;
        }

        .success-message {
            text-align: center;
            padding: 40px;
            background-color: #e6ffe6;
            border: 1px solid var(--success);
            border-radius: 8px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loaded-element {
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 10px 20px;
            }
            .hero {
                padding-top: 70px;
                min-height: 40vh;
            }
            .hero h1 {
                font-size: 2rem;
            }
            .step-indicator {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            .calendar-wrapper {
                overflow-x: scroll;
            }
        }
    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">Psicofitt</a>
        <div class="header-actions">
            <a href="portal.html" id="login-btn-header" class="btn-secondary"><i class="fas fa-user-lock"></i> Sesión Profesional</a>
        </div>
    </header>

    <div class="hero">
        <div class="hero-content">
            <h1>Agenda tu Sesión de Bienestar Psicológico</h1>
            <p>El primer paso hacia tu equilibrio. Revisa nuestra disponibilidad semanal y reserva en 5 minutos.</p>
            <button class="btn-main" onclick="showStep(2)">Comenzar Agenda <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <main>
        
        <div class="process-steps">
            <div class="step-indicator active" data-step="1">1. Servicio</div>
            <div class="step-indicator" data-step="2">2. Horario</div>
            <div class="step-indicator" data-step="3">3. Datos</div>
            <div class="step-indicator" data-step="4">4. Confirmar</div>
        </div>

        <div id="step-1" class="step-content active">
            <h2>Paso 1: Elige tu Servicio</h2>
            <p>Selecciona el tipo de consulta que mejor se adapte a tus necesidades. Solo mostramos servicios con disponibilidad.</p>
            <div id="service-list">
                <p>Cargando servicios disponibles...</p>
            </div>
            
            <div class="form-nav-buttons">
                <div></div>
                <button class="btn-main" id="next-to-step-2" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div id="step-2" class="step-content" style="display: none;">
            <h2>Paso 2: Elige Fecha y Hora</h2>
            <p id="selected-service-info"></p>

            <div class="week-controls">
                <div style="display:flex;gap:8px;align-items:center">
                    <button id="prev-week" class="btn-nav" onclick="changeWeek(-7)">
                        <i class="fas fa-chevron-left"></i> Semana anterior
                    </button>
                    <button id="next-week" class="btn-nav" onclick="changeWeek(7)">
                        Semana siguiente <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div style="display:flex;align-items:center;gap:18px">
                    <div class="week-label" id="week-label">Cargando semana...</div>
                </div>
            </div>
            
            <div class="calendar-wrapper" id="calendar-wrap">
                <table class="calendar-table" aria-label="Calendario semanal">
                    <thead>
                        <tr id="calendar-head">
                            <th class="time-col">Hora</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        </tbody>
                </table>
            </div>

            <div class="form-nav-buttons">
                <button class="btn-secondary" onclick="showStep(1)"><i class="fas fa-chevron-left"></i> Anterior</button>
                <button class="btn-main" id="next-to-step-3" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
        
        <div id="step-3" class="step-content" style="display: none;">
            <h2 id="reserva-form-title">Paso 3: Ingresa tus Datos</h2>
            <p>Estás a punto de confirmar tu hora para <strong id="summary-time"></strong>. Por favor, completa tus datos para asegurar la reserva.</p>
            
            <form id="paciente-data-form">
                <div class="form-group">
                    <label for="paciente_nombre">Nombre Completo</label>
                    <input type="text" id="paciente_nombre" required>
                </div>
                <div class="form-group">
                    <label for="paciente_rut">RUT/DNI</label>
                    <input type="text" id="paciente_rut" required>
                </div>
                <div class="form-group">
                    <label for="paciente_email">Email</label>
                    <input type="email" id="paciente_email" required>
                </div>
                <div class="form-group">
                    <label for="paciente_celular">Celular</label>
                    <input type="tel" id="paciente_celular" required>
                </div>
                <div class="form-group">
                    <label for="paciente_prevision">Previsión / Isapre / Fonasa (Opcional)</label>
                    <input type="text" id="paciente_prevision">
                </div>
                <div class="form-group">
                    <label for="comentarios">Comentarios o Motivo de Consulta (Breve)</label>
                    <textarea id="comentarios" rows="3" required></textarea>
                </div>
            </form>
            
            <div class="form-nav-buttons">
                <button class="btn-secondary" onclick="showStep(2)"><i class="fas fa-chevron-left"></i> Anterior</button>
                <button class="btn-main" id="next-to-step-4">Revisar Reserva <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="step-4" class="step-content" style="display: none;">
            <h2>Paso 4: Confirma los Datos</h2>
            <p>Por favor, revisa que toda la información sea correcta antes de finalizar la reserva.</p>
            
            <div id="review-summary" style="padding: 20px; background: #fffaf0; border: 1px dashed var(--accent); border-radius: 8px; margin-bottom: 20px;">
                </div>
            
            <div id="status-message"></div>

            <div class="form-nav-buttons">
                <button class="btn-secondary" onclick="showStep(3)"><i class="fas fa-chevron-left"></i> Volver a Datos</button>
                <button class="btn-main" id="confirm-booking-btn">Confirmar Reserva</button>
            </div>
        </div>

        <div id="step-5" class="step-content" style="display: none;">
            <div class="success-message">
                <h2><i class="fas fa-check-circle" style="color: var(--success); font-size: 2.5rem;"></i> ¡Reserva Confirmada!</h2>
                <p>Tu cita ha sido agendada con éxito.</p>
                <div id="final-confirmation-details"></div>
                <p>Recibirás un correo de confirmación con los detalles y el enlace para la videollamada.</p>
                <button class="btn-secondary" onclick="window.location.reload()"><i class="fas fa-home"></i> Volver a Inicio</button>
            </div>
        </div>

    </main>

    <footer>
        </footer>

    <script>
        // --- CREDENCIALES DE SUPABASE ---
        const supabaseUrl = 'https://sncznbowdiarakoekxit.supabase.co'; 
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuY3puYm93ZGlhcmFrb2VreGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNTcwMTgsImV4cCI6MjA3NTkzMzAxOH0.X7hSM3_h0kPPpbxm-y7pbtOPXpnmk41uiwrN4lnGRJU'; 
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // --- ESTADO GLOBAL ---
        let services = [];
        let selectedService = null;
        let currentWeekStart = new Date(); 
        const startHour = 9, endHour = 18, slotIntervalMin = 45; 
        let timeSlots = [];
        let agendaMap = new Map(); // Mapa de la agenda: Clave es ID_AGENDA, valor es objeto de reserva
        let selectedTimeSlot = null; // Objeto de la hora seleccionada
        
        // --- ELEMENTOS DOM ---
        const stepIndicators = document.querySelectorAll('.step-indicator');
        const serviceListEl = document.getElementById('service-list');
        const nextToStep2Btn = document.getElementById('next-to-step-2');
        const selectedServiceInfoEl = document.getElementById('selected-service-info');
        const calendarHead = document.getElementById('calendar-head');
        const calendarBody = document.getElementById('calendar-body');
        const weekLabel = document.getElementById('week-label');
        const nextToStep3Btn = document.getElementById('next-to-step-3');
        const nextToStep4Btn = document.getElementById('next-to-step-4');
        const confirmBookingBtn = document.getElementById('confirm-booking-btn');
        const statusMessage = document.getElementById('status-message');
        const reviewSummaryEl = document.getElementById('review-summary');
        const summaryTimeEl = document.getElementById('summary-time');
        const pacienteDataForm = document.getElementById('paciente-data-form');

        // --- UTILIDADES DE TIEMPO ---
        function pad(n){ return String(n).padStart(2,'0'); }
        function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
        function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

        function getStartOfWeek(date){
            const d = new Date(date);
            const day = d.getDay(); 
            const diff = (day === 0 ? -6 : 1) - day; 
            d.setDate(d.getDate() + diff);
            d.setHours(0,0,0,0);
            return d;
        }
        function generateTimeSlots(){
            timeSlots = [];
            const temp = new Date();
            temp.setHours(startHour,0,0,0);
            while (temp.getHours() < endHour || (temp.getHours() === endHour && temp.getMinutes() === 0)) {
                const t = `${pad(temp.getHours())}:${pad(temp.getMinutes())}`;
                timeSlots.push(t);
                temp.setMinutes(temp.getMinutes() + slotIntervalMin);
            }
        }
        generateTimeSlots();

        // --- FUNCIONES DEL FLUJO ---

        // 🛑 CORRECCIÓN CLAVE: Función para cambiar de paso SIN forzar el scroll al tope de la página
        function showStep(stepNumber) {
            document.querySelectorAll('.step-content').forEach(el => {
                el.style.display = 'none';
            });
            
            const target = document.getElementById(`step-${stepNumber}`);
            if (target) {
                target.style.display = 'block';
                // 🛑 NO SE USA target.scrollIntoView() AQUÍ PARA EVITAR EL SALTO
            }
            
            // Actualizar indicadores de paso
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active');
                if (parseInt(indicator.dataset.step) === stepNumber) {
                    indicator.classList.add('active');
                }
            });
            
            // Forzar un scroll suave pero solo si estamos avanzando en el proceso de reserva
            if (stepNumber >= 2 && stepNumber <= 4) {
                document.querySelector('main').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ... (El resto del código CRUD de servicios, calendario y reserva se mantiene igual al anterior) ...
        // *NOTA: Por temas de extensión, el código completo se mantiene en los archivos, aquí solo se muestra el cambio clave*

        /****************** Inicializar ******************/
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar al primer paso
            showStep(1); 
            
            // Cargar datos (servicios)
            loadServices();
            
            // 🛑 CORRECCIÓN: Manejar el clic del botón de login para que no cause scroll.
            const loginButton = document.getElementById('login-btn-header');
            if (loginButton) {
                loginButton.onclick = (e) => { 
                    e.preventDefault(); 
                    window.location.href = 'portal.html'; 
                };
            }
            
            // Manejadores de eventos de navegación (mantener lógica de validación)
            nextToStep2Btn.addEventListener('click', () => {
                if (selectedService) {
                    showStep(2);
                    loadWeekSchedule(); // Cargar agenda al pasar al paso 2
                }
            });

            nextToStep3Btn.addEventListener('click', () => {
                if (selectedTimeSlot) {
                    updateSummaryTime();
                    showStep(3);
                }
            });

            nextToStep4Btn.addEventListener('click', () => {
                if (pacienteDataForm.checkValidity()) {
                    updateReviewSummary();
                    showStep(4);
                } else {
                    pacienteDataForm.reportValidity();
                }
            });

            confirmBookingBtn.addEventListener('click', confirmBooking);

            // Carga inicial de agenda
            currentWeekStart = getStartOfWeek(currentWeekStart);
        });
    </script>
</body>
</html>
